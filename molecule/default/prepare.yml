---
- name: Prepare
  gather_facts: true
  hosts: all

  vars:
    role_path: "{{ playbook_dir }}/../.."  # noqa: var-naming[read-only]
    ansible_user: ansible
    ansible_password: ansible
    ansible_become_password: ansible

  tasks:
    - name: Include OS-specific variables
      ansible.builtin.include_vars: "{{ var_file }}"
      with_first_found:
        - "{{ role_path }}/vars/{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/vars/{{ ansible_os_family }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ role_path }}/vars/{{ ansible_distribution }}.yml"
        - "{{ role_path }}/vars/{{ ansible_os_family }}.yml"
        - "{{ role_path }}/vars/{{ ansible_lsb.id }}.yml"
      loop_control:
        loop_var: var_file

    - name: Create group to be removed
      ansible.builtin.group:
        name: removeme
        state: present
      become: true

    - name: Create user to be removed
      ansible.builtin.user:
        name: removeduser
        uid: 9999
        state: present
        shell: /bin/bash
        create_home: true
      become: true

    - name: Set OS-specific root group
      ansible.builtin.set_fact:
        user_setup_root_group: "{{ 'wheel' if ansible_os_family == 'FreeBSD' else 'root' }}"

    - name: Set visudo path for OS family
      ansible.builtin.set_fact:
        user_setup_visudo_path: "{{ '/usr/local/sbin/visudo' if ansible_os_family == 'FreeBSD' else '/usr/sbin/visudo' }}"

    - name: Ensure sudoers.d directory exists
      ansible.builtin.file:
        path: "{{ user_setup_sudoers_d_dir }}"
        state: directory
        mode: "0750"
        owner: root
        group: "{{ user_setup_root_group }}"
      become: true

    - name: Create sudoers file for user to be removed
      ansible.builtin.copy:
        content: "removeduser ALL=(ALL) NOPASSWD:ALL\n"
        dest: "{{ user_setup_sudoers_d_dir }}removeduser"
        mode: "0440"
        owner: root
        group: "{{ user_setup_root_group }}"
        validate: "{{ user_setup_visudo_path}} -cf %s"
      become: true
